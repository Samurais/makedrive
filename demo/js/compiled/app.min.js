/*! makedrive 0.0.20 2014-08-06 */

angular.module("makedriveApp",["ui.bootstrap","makedriveApp.services","webmakerAngular.login"]),angular.module("makedriveApp").controller("editor",["$window",function($window){ace.config.set("basePath","/vendors/ace-builds/src-min"),$window.editor=ace.edit(document.getElementById("editor")),editor.setTheme("ace/theme/monokai"),editor.getSession().setMode("ace/mode/javascript")}]).controller("mkdir",["$window","$scope",function($window,$scope){$scope.mkdirp=function(path){var sh=$window.MakeDrive.fs().Shell(),fs=$window.MakeDrive.fs({manual:!0}),sync=fs.sync;sh.mkdirp("/"+path,function(e){e&&console.error(e),sync.request("/")})}}]).controller("mkfile",["$window","$scope",function($window,$scope){$scope.mkfile=function(path){var sh=$window.MakeDrive.fs().Shell(),Path=$window.MakeDrive.Path,fs=$window.MakeDrive.fs({manual:!0}),sync=fs.sync;sh.mkdirp("/"+Path.dirname(path),function(e){e&&console.error(e),fs.writeFile("/"+path,$window.editor.getValue(),function(e){e&&console.error(e),sync.request("/")})})}}]).controller("clickToggle",["$scope",function($scope){$scope.toggled=!1,$scope.toggle=function(){$scope.toggled=!$scope.toggled,$("#wrapper").toggleClass("toggled")}}]).controller("init",["getList","$window","$scope","param",function(getList,$window,$scope,param){var fs=$window.MakeDrive.fs({manual:!0}),sync=fs.sync;sync.on("connected",function(){getList(),console.log("server has connected")}),sync.connect(param("makedrive")),sync.on("completed",function(){getList(),$("#success").fadeIn(1e3),$("#success").fadeOut(5e3)}),sync.on("error",function(e){$scope.error=e.message,$("#error").fadeIn(1e3),$("#error").fadeOut(5e3)})}]),angular.module("webmakerAngular.login",[]).factory("webmakerLoginService",["$rootScope","$window",function($rootScope,$window){function apply(){$rootScope.$$phase||$rootScope.$apply()}var auth=new $window.WebmakerAuthClient;return $rootScope.login=auth.login,$rootScope.logout=auth.logout,$rootScope._user={},auth.on("login",function(user){$rootScope._user=user,apply()}),auth.on("logout",function(){$rootScope._user={},apply()}),auth.on("error",function(message,xhr){console.log("error",message,xhr)}),auth}]).controller("createUserController",["$scope","$http","$modal","webmakerLoginService",function($scope,$http,$modal,webmakerLoginService){webmakerLoginService.on("newuser",function(assertion){$modal.open({templateUrl:"/views/create-user-form.html",controller:createUserCtrl,resolve:{assertion:function(){return assertion}}})});var createUserCtrl=function($scope,$modalInstance,webmakerLoginService,assertion){$scope.form={},$scope.user={};var usernameRegex=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-]{1,20}$/;$scope.checkUsername=function(){if($scope.form.user.username){if(!usernameRegex.test($scope.form.user.username.$viewValue))return void $scope.form.user.username.$setValidity("invalid",!1);$scope.form.user.username.$setValidity("invalid",!0),$http.post(webmakerLoginService.urls.checkUsername,{username:$scope.form.user.username.$viewValue}).success(function(username){$scope.form.user.username.$setValidity("taken",!username.exists)}).error(function(){$scope.form.user.username.$setValidity("taken",!0)})}},$scope.createUser=function(){$scope.submit=!0,$scope.form.user.$valid&&$scope.form.agree&&(webmakerLoginService.createUser({assertion:assertion,user:$scope.user}),$modalInstance.close())},$scope.cancel=function(){webmakerLoginService.analytics.webmakerNewUserCancelled(),$modalInstance.dismiss("cancel")}};webmakerLoginService.verify()}]),angular.module("makedriveApp.services",[]).factory("getList",["$rootScope","$http","$window",function($rootScope,$http,$window){function getContent(data){var listing=[];return data.map(function(content){var node;node="DIRECTORY"!==content.type?{text:content.path,icon:"/demo/assets/document.png"}:{text:content.path},content.contents&&(node.children=getContent(content.contents)),listing.push(node)}),listing}function openFile(){fs.stat($rootScope.selectedPath,function(e,stat){e||stat.isDirectory()||fs.readFile($rootScope.selectedPath,"utf8",function(e,data){e||$window.editor.setValue(data)})})}function remove(){fs.stat($rootScope.selectedPath,function(e,stat){stat.isDirectory()?sh.rm($rootScope.selectedPath,{recursive:!0},function(e){e&&alert(e),sync.request("/")}):fs.unlink($rootScope.selectedPath,function(e){e&&alert(e),sync.request("/")})})}function createTree(data){$("#jstree").jstree({plugins:["contextmenu"],contextmenu:{items:function(){return{Delete:{label:"Delete",action:function(){remove()}}}}},core:{multiple:!1,data:[{text:"/",state:{opened:!0,selected:!1},children:data}]}}).bind("select_node.jstree",function(e,data){var Path=$window.MakeDrive.Path;$rootScope.selectedPath=Path.normalize(data.instance.get_path(data.node).join("/")),openFile()}),jQuery.jstree.reference("#jstree").refresh()}var fs=$window.MakeDrive.fs({manual:!0}),sh=$window.MakeDrive.fs().Shell(),sync=fs.sync;return getListing=function(){jQuery.jstree.reference("#jstree")&&jQuery.jstree.reference("#jstree").destroy(),$http.get("/j/").success(function(data){newListing=getContent(data),createTree(newListing)})}}]).factory("param",["$window",function($window){return getParam=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec($window.location.href);return null==results?null:results[1]||0}}]);
//# sourceMappingURL=app.min.map